<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>診断結果｜ギター占い</title>

  <!-- CSS（キャッシュ更新のため v=9 に） -->
  <link rel="stylesheet" href="style.css?v=9" />

  <!-- OGP（任意） -->
  <meta property="og:title" content="ギター占い｜診断結果">
  <meta property="og:description" content="あなたのギター気質は…？">
  <meta property="og:image" content="og.jpg">
  <meta name="twitter:card" content="summary_large_image">
</head>
<body>
  <header class="hero">
    <h1>ギター占い｜診断結果</h1>
    <p class="subtitle">あなたにぴったりの一本は…？🎸</p>
  </header>

  <div id="result">読み込み中…</div>

  <div class="actions" style="max-width:860px;margin:12px auto 0;text-align:center;">
    <a href="./" class="btn" rel="noopener">🔁 もう一度診断</a>
    <a id="shareX" target="_blank" class="btn" rel="noopener">🕊️ Xでシェア</a>
    <button id="copyLink" class="btn">🔗 リンクをコピー</button>
  </div>

 
<script type="module">
  import { GUITARS } from "./data/guitarTypes.js";

  // ---- キー取得：URL > localStorage の順。DOMは読まない ----
  function getKeyStrict() {
    const params = new URLSearchParams(location.search);
    let key = params.get("type")?.trim().toLowerCase() || "";
    if (!key) {
      try {
        const saved = JSON.parse(localStorage.getItem("guitar_diagnosis") || "{}");
        if (saved && typeof saved.resultKey === "string") key = saved.resultKey.toLowerCase();
      } catch {}
    }
    return key;
  }

  // ---- 表記ゆれ補正（必要最小限） ----
  function normalize(key) {
    const s = (key || "").replace(/\s+/g, "");
    const map = {
      "es335":"es-335",
      "flyingv":"flying-v",
      "prscustom24":"prs-custom-24",
      "yamahapacifica":"yamaha-pacifica",
      "yamahasg":"yamaha-sg",
      "lespaul":"les-paul",
      "lespauljr":"les-paul-junior",
      "lespauljunior":"les-paul-junior",
      "pacifica":"yamaha-pacifica"
    };
    return map[s] || key;
  }

  let key = normalize(getKeyStrict());

  // 不明だったら明示的にエラー表示（自動Stratフォールバックはしない）
  if (!GUITARS[key]) {
    console.error("[guitar-fortune] Unknown result key:", key);
    const err = document.createElement("div");
    err.style.maxWidth = "1000px";
    err.style.margin = "24px auto";
    err.style.padding = "16px";
    err.style.borderRadius = "12px";
    err.style.border = "1px solid rgba(255,0,0,.25)";
    err.style.background = "rgba(255,0,0,.06)";
    err.style.color = "#ffd5d5";
    err.innerHTML = `
      <strong>結果キーが見つかりませんでした。</strong><br>
      URLに <code>?type=telecaster</code> のように付けるか、集計時に
      <code>localStorage.setItem("guitar_diagnosis", JSON.stringify({ resultKey: "telecaster" }))</code>
      を保存してください。
    `;
    (document.querySelector("main") || document.body).appendChild(err);
    throw new Error("Unknown result key");
  }

  const d = GUITARS[key];
// ---- 上部の #result を差し替え ----
const $res = document.getElementById("result");
if ($res) {
  $res.innerHTML = `
    <span class="result-badge">診断結果</span>
    <strong>${d.name}</strong> — ${d.tagline}
  `;
  $res.classList.add("show");
}

  // ---- スタイル注入 ----
  const style = document.createElement("style");
  style.textContent = `
    .g-detail-card{max-width:1000px;margin:24px auto;padding:20px;border-radius:16px;
      background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.12)}
    .g-hero{display:grid;grid-template-columns:1.2fr 1fr;gap:16px;align-items:stretch}
    .g-img{width:100%;height:100%;object-fit:contain;background:rgba(255,255,255,0.04);border-radius:12px}
    .g-info h2{margin:.2rem 0;font-size:1.6rem;font-weight:800}
    .g-tag{display:inline-block;margin-bottom:.5rem;padding:.25rem .6rem;border-radius:999px;
      font-size:.8rem;background:rgba(147,197,253,.15);border:1px solid rgba(147,197,253,.35)}
    .g-tagline{opacity:.85;margin:.25rem 0 1rem}
    .g-persona{opacity:.9}
    .g-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .g-sec{padding:12px;border-radius:12px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08)}
    .g-sec h3{margin:.2rem 0 .4rem;font-size:1rem;opacity:.9}
    .g-sec ul{margin:.2rem 0 .4rem 1.2rem}
    @media (max-width:860px){.g-hero{grid-template-columns:1fr}}
  `;
  document.head.appendChild(style);

  // ---- カード生成 ----
  const host = document.querySelector("main") || document.querySelector("#app") || document.body;
  const card = document.createElement("section");
  card.className = "g-detail-card";
  card.innerHTML = `
    <div class="g-hero">
      <img class="g-img" src="${d.image}" alt="${d.name}">
      <div class="g-info">
        <span class="g-tag">GUITAR TYPE</span>
        <h2>${d.name}</h2>
        <p class="g-tagline">${d.tagline}</p>
        <p class="g-persona">${d.persona}</p>
        <div class="g-grid">
          <div class="g-sec">
            <h3>強み</h3>
            <ul>${d.strengths.map(s=>`<li>${s}</li>`).join("")}</ul>
          </div>
          <div class="g-sec">
            <h3>気をつけたい点</h3>
            <ul>${d.caution.map(s=>`<li>${s}</li>`).join("")}</ul>
          </div>
        </div>
        <div class="g-sec"><h3>アドバイス（仕事/恋愛）</h3><p>${d.loveWorkTips}</p></div>
        <div class="g-sec"><h3>相性が良いタイプ</h3><p>${d.matches.join(" / ")}</p></div>
      </div>
    </div>
  `;
  host.appendChild(card);
  // ---- ここから「もっと詳しく占うなら」ブロック ----
const promo = document.createElement("div");
promo.className = "g-sec";
promo.style.marginTop = "20px";
promo.style.textAlign = "center";
promo.innerHTML = `
  <h3>🔮 もっと詳しく占うなら</h3>
  <p>AIと統計学をベースにした、占髭聖ラジャの本格鑑定はこちらから</p>
  <p>
    <a href="https://twitter.com/senbiseiraja" target="_blank" class="btn">🕊️ Xで最新情報をチェック</a>
    <a href="https://coconala.com/users/5422205" target="_blank" class="btn">🌙 ココナラ鑑定はこちら</a>
  </p>
`;
host.appendChild(promo);
// ---- ここまで ----

  // ---- 共有リンクとコピー機能 ----

// 共有するURL（トップ＝index.html のある場所を想定）
const baseUrl = new URL(".", location.href).href; // 例: https://user.github.io/repo/
const shareText = `私は『${d.name}』タイプでした！ #ギター占い`;

// X(Twitter)：intent URL をセット
const shareX = document.getElementById("shareX");
if (shareX) {
  const intent = new URL("https://twitter.com/intent/tweet");
  intent.searchParams.set("text", shareText);
  intent.searchParams.set("url", baseUrl);
  shareX.href = intent.toString();

  // Web Share API が使えるなら、クリックでネイティブ共有に切替
  if (navigator.share) {
    shareX.addEventListener("click", async (e) => {
      e.preventDefault();
      try {
        await navigator.share({ title: "ギター占い", text: shareText, url: baseUrl });
      } catch (_) { /* キャンセル時は何もしない */ }
    });
  }
}

// リンクをコピー
const copyBtn = document.getElementById("copyLink");
if (copyBtn) {
  copyBtn.addEventListener("click", async () => {
    const text = baseUrl;
    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        // フォールバック（HTTPS以外や権限なし環境用）
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }
      const old = copyBtn.textContent;
      copyBtn.textContent = "コピーしました！";
      setTimeout(() => (copyBtn.textContent = old), 1400);
    } catch (err) {
      alert("コピーに失敗しました");
      console.error(err);
    }
  });
}

</script>
</body>
</html>
